<div>
  <table class="table-responsive table-bordered">
    <thead table-header
           [configurations]="configurations"
           [withIndex]="showIndex"
           [withActions]="showActions" [actionsHeader]="actionsHeader"></thead>
    <tbody>
    <ng-container *ngIf="!tableDataInternal.groupData">
        <tr *ngFor="let row of tableDataInternal.data; let rowIndex = index; trackBy: trackByIndex">
          <td *ngIf="showIndex">{{ getRowIndex(rowIndex) }}</td>
          <td *ngFor="let data of row; let colIndex = index; trackBy: trackByIndex"
              table-cell
              #cell
              [rowSpan]="cell['rowspan']"
              [column]="colIndex"
              [row]="rowIndex"
              [columnWord]="words[colIndex]"
              [wordAddress]="words[colIndex] + '.' + rowIndex"
              [columnConfigs]="configurations.states.columns[colIndex]">
          </td>
          <ng-container *ngFor="let action of configs.actions; let actionIndex = index">
            <ng-container *ngTemplateOutlet="actionsTemplate; context: { rowIndex: rowIndex, index: actionIndex }"></ng-container>
          </ng-container>
        </tr>
    </ng-container>
    <ng-container *ngIf="tableDataInternal.groupData">
      <ng-container *ngTemplateOutlet="groupTemplate; context: { rowGroups: tableDataInternal.groupData }"></ng-container>
    </ng-container>
    </tbody>
  </table>
</div>

<ng-template #groupTemplate let-rowGroups="rowGroups" let-parentIndex="parentIndex" let-parentText="parentText">
  <ng-container *ngFor="let group of rowGroups; let groupIndex = index">
    <tr>
      <td>{{ group.indexFn(groupIndex, { parentIndex: parentIndex, parentText: parentText }) }}</td>
      <ng-container *ngFor="let col of groupColumns; let colIndex = index">
        <td>{{ colIndex === 0 ? group.name : '' }}</td>
      </ng-container>
    </tr>
    <ng-container *ngIf="group.data">
      <tr *ngFor="let row of group.data; let rowIndex = index; trackBy: trackByIndex">
        <td *ngIf="showIndex">
          {{ getRowIndex(rowIndex, {
              parentIndex: groupIndex,
              parentText: group.indexFn(groupIndex, { parentIndex: parentIndex, parentText: parentText })
            })
          }}
        </td>
        <td *ngFor="let data of row; let colIndex = index; trackBy: trackByIndex"
            table-cell
            #cell
            [column]="colIndex"
            [row]="rowIndex"
            [group]="group"
            [columnWord]="words[colIndex]"
            [wordAddress]="words[colIndex] + '.' + rowIndex"
            [columnConfigs]="configurations.states.columns[colIndex]">
        </td>
        <ng-container *ngFor="let action of configs.actions; let actionIndex = index">
          <ng-container *ngTemplateOutlet="actionsTemplate; context: { rowIndex: rowIndex, group: group, index: actionIndex }"></ng-container>
        </ng-container>
        <td>
        </td>
      </tr>
    </ng-container>
    <ng-container *ngIf="group.subGroups">
      <ng-container *ngTemplateOutlet="groupTemplate; context: {
        rowGroups: group.subGroups,
        parentIndex: groupIndex,
        parentText: group.indexFn(groupIndex, { parentIndex: parentIndex, parentText: parentText })
      }"></ng-container>
    </ng-container>
  </ng-container>
</ng-template>

<ng-template #actionsTemplate let-rowIndex="rowIndex" let-group="group" let-index="index">
  <td *ngIf="showActions">
    <ng-container *ngFor="let action of getActions(index, rowIndex, group)">
      <span (click.out-zone)="onActionClicked(index, action, rowIndex, group)">
        {{ configs.actions[index].types[action].name }}
      </span>
    </ng-container>
  </td>
</ng-template>